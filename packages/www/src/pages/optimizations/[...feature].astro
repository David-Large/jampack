---
import MainLayout from '../../layouts/MainLayout.astro';
import FileTree from '../../components/FileTree/FileTree.astro';
import path from 'path';
import { execSync } from 'child_process';

export function getStaticPaths() {
  return [
    {params: {feature: 'feature1'}},
  ]
}

const { feature } = Astro.params;

// Loading the feature description
// (this loading is complex because it's a dynamic import)
//
const content = (await Astro.glob('../../../public/features/*/index.md')).find(m => m.file === path.resolve(`public/features/${feature}/index.md`));

// Pack 
//
const root = `public/features/${feature}`
const packed = `${root}/packed`
const source = `${root}/source`
execSync(`rm -fr ${packed} && mkdir ${packed}`);
execSync(`cp ${source}/* ${packed}`);
const result = execSync(`node ../../dist/index.js ${packed}`);

const iframeSource = `/features/${feature}/source/index.html`;
const iframePacked = `/features/${feature}/packed/index.html`;
---
<MainLayout frontmatter={{ title: content.frontmatter.title, description: 'todo', layout: undefined}} headings={content.getHeadings()}>

  <p>{ content.rawContent }</p>

  <h2>Demo</h2>

  <div class="grid">
    <FileTree title="SOURCE" path={source}>
    </FileTree>  
    <FileTree title="PACKED" path={packed}>
    </FileTree>
    <div class="iframe-shrinker">
      <iframe style="width: 100%; height: 100%;" src={iframeSource}></iframe>
    </div>
    <div class="iframe-shrinker">
      <iframe style="width: 100%; height: 100%;" src={iframePacked}></iframe>
    </div>
    <a href={iframeSource} target="_source">Open in new tab</a>
    <a href={iframePacked} target="_packed">Open in new tab</a>
  </div>

  <section class="window">
    <div class="title">
      <div class="buttons">
        <div class="close"></div>
        <div class="minimize"></div>
        <div class="zoom"></div>
      </div>
      Terminal
    </div>
  
    <pre id="terminal" class="astro-code">
      <code>
        { result.toString().trim() }
      </code>
    </pre>
  </section>
</MainLayout>

<script>
  // Scroll the terminal to the end automatically
  var terminalElement = document.getElementById("terminal");
  terminalElement.scrollTop = terminalElement.scrollHeight;
</script>

<style>
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: max-content 300px min-content;
    gap: 1rem;
  }

  .iframe-shrinker {
    width: 200%;
    height: 200%;
    transform-origin: 0 0;
    transform: scale(0.5);
  }

  #terminal {
    max-height: 360px;
    overflow-y: auto;
  }

  .window {
    border: 1px solid #acacac;
    border-radius: 6px;
    background-color: black;
    overflow: hidden;
  }

  .title {
    margin: 0;
    background: #ebebeb;
    color: #4d494d;
    font-size: 11pt;
    line-height: 20px;
    text-align: center;
    width: 100%;
    height: 24px;
    border-top: 1px solid #f3f1f3;
    border-bottom: 1px solid #b1aeb1;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -o-user-select: none;
    cursor: default;
  }

  .buttons {
    padding-left: 8px;
    padding-top: 3px;
    float: left;
    line-height: 0px;
  }

  .buttons > div {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .close {
    background: #ff5c5c;
    border: 1px solid #e33e41;
  }

  .minimize {
    background: #ffbd4c;
    margin-left: 4px;
    border: 1px solid #e09e3e;
  }

  .zoom {
    background: #00ca56;
    margin-left: 4px;
    border: 1px solid #14ae46;
  }

</style>
